"""
Frontend Streamlit para Doc Extractor
"""
import streamlit as st
import requests
import json
from pathlib import Path
import base64
import sys

# Adicionar src ao path
sys.path.append(str(Path(__file__).parent.parent))

from src.config import (
    APP_PORT, BACKEND_PORT, MAX_FILE_SIZE_MB,
    ALLOWED_EXTENSIONS, DEFAULT_PROVIDER
)

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Doc Extractor - Extra√ß√£o Inteligente de Documentos",
    page_icon="üìÑ",
    layout="wide"
)

# URL do backend
BACKEND_URL = f"http://localhost:{BACKEND_PORT}"

# Estilos CSS
st.markdown("""
<style>
    .main-header {
        text-align: center;
        padding: 2rem 0;
        background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .stAlert {
        background-color: #f0f2f6;
        border-radius: 5px;
        padding: 1rem;
        margin: 1rem 0;
    }
    .upload-area {
        border: 2px dashed #cccccc;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        background-color: #fafafa;
    }
</style>
""", unsafe_allow_html=True)

# Header
st.markdown("""
<div class="main-header">
    <h1>üìÑ Doc Extractor</h1>
    <p>Extra√ß√£o Inteligente de Documentos com IA</p>
</div>
""", unsafe_allow_html=True)

# Inicializar estado da sess√£o
if 'api_key' not in st.session_state:
    st.session_state.api_key = ""
if 'provider' not in st.session_state:
    st.session_state.provider = DEFAULT_PROVIDER

# Sidebar para configura√ß√£o
with st.sidebar:
    st.header("‚öôÔ∏è Configura√ß√£o")
    
    # Sele√ß√£o do Provider
    provider = st.selectbox(
        "Provider de IA",
        options=["claude", "gemini"],
        index=0 if DEFAULT_PROVIDER == "claude" else 1,
        help="Escolha o modelo de IA para extra√ß√£o"
    )
    st.session_state.provider = provider
    
    # API Key
    api_key = st.text_input(
        "API Key",
        type="password",
        value=st.session_state.api_key,
        help="Sua chave de API (n√£o ser√° armazenada)"
    )
    st.session_state.api_key = api_key
    
    # Tipo de extra√ß√£o
    extraction_type = st.radio(
        "Tipo de Extra√ß√£o",
        options=["basic", "advanced"],
        format_func=lambda x: "B√°sica (Documento √önico)" if x == "basic" else "Avan√ßada (M√∫ltiplos Documentos)",
        help="B√°sica: RG, CPF, CNH | Avan√ßada: PDFs com m√∫ltiplos documentos"
    )
    
    # Para extra√ß√£o avan√ßada
    document_type = None
    if extraction_type == "advanced":
        document_type = st.selectbox(
            "Tipo de Registro",
            options=["nascimento", "casamento", "obito"],
            format_func=lambda x: x.capitalize()
        )
    
    # Modo de opera√ß√£o
    mode = st.radio(
        "Modo de Opera√ß√£o",
        options=["automatic", "manual"],
        format_func=lambda x: "Autom√°tico com IA" if x == "automatic" else "Manual",
        help="Autom√°tico: IA extrai os dados | Manual: Voc√™ preenche os campos"
    )
    
    # Status do Backend
    st.divider()
    try:
        response = requests.get(f"{BACKEND_URL}/health", timeout=2)
        if response.status_code == 200:
            st.success("‚úÖ Backend conectado")
        else:
            st.error("‚ùå Backend n√£o respondendo")
    except:
        st.error("‚ùå Backend offline")

# √Årea principal
col1, col2 = st.columns([1, 1])

with col1:
    st.header("üì§ Upload de Documento")
    
    # Valida√ß√£o antes do upload
    if not api_key:
        st.warning("‚ö†Ô∏è Por favor, configure sua API Key na barra lateral")
    
    # Upload de arquivo
    uploaded_file = st.file_uploader(
        "Arraste ou selecione seu documento",
        type=['pdf', 'jpg', 'jpeg', 'png'],
        help=f"Tamanho m√°ximo: {MAX_FILE_SIZE_MB}MB"
    )
    
    if uploaded_file is not None:
        # Validar tamanho
        file_size_mb = len(uploaded_file.getvalue()) / (1024 * 1024)
        if file_size_mb > MAX_FILE_SIZE_MB:
            st.error(f"‚ùå Arquivo muito grande! M√°ximo: {MAX_FILE_SIZE_MB}MB")
        else:
            st.success(f"‚úÖ Arquivo carregado: {uploaded_file.name} ({file_size_mb:.2f}MB)")
            
            # Preview para imagens
            if uploaded_file.type in ["image/jpeg", "image/png", "image/jpg"]:
                st.image(uploaded_file, caption="Preview do documento", use_column_width=True)
            
            # Bot√£o de processar
            if st.button("üöÄ Processar Documento", disabled=not api_key, type="primary"):
                with st.spinner("Processando..."):
                    try:
                        # Preparar dados para envio
                        files = {"file": (uploaded_file.name, uploaded_file.getvalue(), uploaded_file.type)}
                        data = {
                            "provider": provider,
                            "api_key": api_key,
                            "extraction_type": extraction_type,
                            "document_type": document_type,
                            "mode": mode
                        }
                        
                        # Fazer requisi√ß√£o
                        response = requests.post(
                            f"{BACKEND_URL}/api/extract",
                            files=files,
                            data=data,
                            timeout=300
                        )
                        
                        if response.status_code == 200:
                            result = response.json()
                            st.session_state.extraction_result = result
                            st.success("‚úÖ Documento processado com sucesso!")
                        else:
                            st.error(f"‚ùå Erro: {response.text}")
                            
                    except Exception as e:
                        st.error(f"‚ùå Erro na comunica√ß√£o: {str(e)}")

with col2:
    st.header("üìã Resultados da Extra√ß√£o")
    
    if 'extraction_result' in st.session_state:
        result = st.session_state.extraction_result
        
        # Mostrar status
        st.info(f"Provider: {result.get('provider', 'N/A')}")
        st.info(f"Tipo de Extra√ß√£o: {result.get('extraction_type', 'N/A')}")
        
        # Mostrar dados extra√≠dos (por enquanto mock)
        st.subheader("Dados Extra√≠dos")
        extracted_data = result.get('data', {}).get('extracted_fields', {})
        
        if extracted_data:
            # Mostrar campos em formato edit√°vel
            edited_data = {}
            for field, value in extracted_data.items():
                edited_data[field] = st.text_input(field, value=value)
        else:
            st.info("Aguardando processamento...")
        
        # Bot√µes de a√ß√£o
        col_btn1, col_btn2, col_btn3 = st.columns(3)
        
        with col_btn1:
            if st.button("üìã Copiar JSON"):
                json_str = json.dumps(result.get('data', {}), indent=2, ensure_ascii=False)
                st.code(json_str, language="json")
                st.success("‚úÖ Copiado para √°rea de transfer√™ncia!")
        
        with col_btn2:
            if st.button("üìÑ Exportar PDF"):
                st.info("üöß Funcionalidade em desenvolvimento")
        
        with col_btn3:
            if extraction_type == "advanced" and st.button("üìù Exportar XML"):
                st.info("üöß Funcionalidade em desenvolvimento")
    else:
        st.info("üëÜ Fa√ßa upload de um documento para come√ßar")

# Footer
st.divider()
st.markdown("""
<div style='text-align: center; color: #888;'>
    <p>Doc Extractor v0.1.0 | Desenvolvido para extra√ß√£o inteligente de documentos</p>
</div>
""", unsafe_allow_html=True)